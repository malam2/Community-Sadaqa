name: Deploy to Azure Container Apps

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - dev
          - PROD

env:
  AZURE_CONTAINER_REGISTRY: sadaqaregistry
  RESOURCE_GROUP: sadaqa-rg
  IMAGE_NAME: sadaqa-server

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push image to ACR
        run: |
          APP_NAME=${{ github.event.inputs.environment == 'PROD' && 'sadaqa-api' || 'sadaqa-api-dev' }}
          
          # Get the container app URL for the API domain
          DOMAIN=$(az containerapp show \
            --name $APP_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv 2>/dev/null || echo "")
          
          # Build with the domain passed as build arg
          az acr build \
            --registry ${{ env.AZURE_CONTAINER_REGISTRY }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.event.inputs.environment }} \
            --file deploy/docker/Dockerfile \
            --build-arg EXPO_PUBLIC_DOMAIN=${DOMAIN} \
            .

      - name: Deploy to Container App
        id: deploy
        run: |
          APP_NAME=${{ github.event.inputs.environment == 'PROD' && 'sadaqa-api' || 'sadaqa-api-dev' }}
          NODE_ENV=${{ github.event.inputs.environment == 'PROD' && 'production' || 'development' }}
          
          az containerapp update \
            --name $APP_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --set-env-vars "NODE_ENV=$NODE_ENV" "DATABASE_URL=${{ secrets.DATABASE_URL }}"
          
          URL=$(az containerapp show \
            --name $APP_NAME \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Create deployment summary
        run: |
          EMOJI=${{ github.event.inputs.environment == 'PROD' && 'ðŸš€' || 'ðŸ§ª' }}
          ENV_LABEL=${{ github.event.inputs.environment == 'PROD' && 'Production' || 'Development' }}
          echo "## $EMOJI $ENV_LABEL Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
